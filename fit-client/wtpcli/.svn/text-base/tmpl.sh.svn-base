#!/bin/sh
# create tmpl.c
#   using tmpl.h tmpl/*.h > tmpl.c 
##help
# Usage: tmpl.sh tmpl.c tmpl.h tmpl/*.h ....
##version
# v1.0   2016/01/20  jinfang.chen
##

# 1.0 include
ALL=(tmpl.h $(ls -1 tmpl/* 2>/dev/null | tr -s "\r\n" " "))
TMP=/tmp/tmp.$$
trap "rm -f $TMP; exit;" INT QUIT TERM EXIT

# 2.0 function 
# trim comment:      ^  //comment       //comment           /* comment */         /* comment \r\n comment ... */
function trim(){
# 1.1 delete ^[\t ]*//comment
# 1.2 delete //comment 
# 1.3 delete /* comment */
# 2.1 /*  ->  \r\n/* 
# 2.2 */  ->  */\r\n
# 3   delete /* ... \r\n ... \r\n ... */ 
sed -e "/^[ \t]*\/\//d" -e "s/\/\/[^\"]*//" -e "s/\/\*.*\*\///" $@ | \
	sed -e "s,/\*,\r\n/\*," -e "s,\*\/[\t ]*,\*\/\r\n,"            | \
	sed -e "/^[ \t]*\/\*/,/.*\*\//d"
}
# create cmds
function create()
{
	# header
	echo "#define __TMPL_C__ 1"
	echo "#include <tmpl.h>"
	ls -1 tmpl/*.h 2>/dev/null | awk '{print "#include <" $1 ">";}'
	
	# tmpl_init
	echo "void tmpl_init(void) {" 

	# common 
	echo -e "\t/* common command */"
	grep ^tmpl $1 | awk '{print "\tinstall_element(VAMD_NODE,&"$1");" ;}'
	grep ^tmpl $1 | awk '{print "\tinstall_element(VAMD_TECH_NODE,&"$1");" ;}'
	grep ^tmpl $1 | awk '{print "\tinstall_element(VCSD_NODE,&"$1");" ;}'
	grep ^tmpl $1 | awk '{print "\tinstall_element(VCSD_TECH_NODE,&"$1");" ;}'

	# vamd | vcsd only
	echo -e "\n\t/* VAMD only */"
	grep ^vamd $1 | awk '{print "\tinstall_element(VAMD_NODE,&"$1");" ;}'
	grep ^vamd $1 | awk '{print "\tinstall_element(VAMD_TECH_NODE,&"$1");" ;}'
	echo -e "\n\t/* VCSD only */"
	grep ^vcsd $1 | awk '{print "\tinstall_element(VCSD_NODE,&"$1");" ;}'
	grep ^vcsd $1 | awk '{print "\tinstall_element(VCSD_TECH_NODE,&"$1");" ;}'

	# tech only
	echo -e "\n\t/* common tech only */"
	grep ^tech $1 | grep -v '^tech_v[ac][ms]d' | awk '{print "\tinstall_element(VAMD_TECH_NODE,&"$1");" ;}'
	grep ^tech $1 | grep -v '^tech_v[ac][ms]d' | awk '{print "\tinstall_element(VCSD_TECH_NODE,&"$1");" ;}'
	echo -e "\n\t/* VAMD tech only */"
	grep ^tech_vamd $1 | awk '{print "\tinstall_element(VAMD_TECH_NODE,&"$1");" ;}'
	echo -e "\n\t/* VCSD tech only */"
	grep ^tech_vcsd $1 | awk '{print "\tinstall_element(VCSD_TECH_NODE,&"$1");" ;}'

	echo -e "\n\t/* ALL done: total $(wc -l $1| awk '{print $1}') commands */\n"
	echo -e "}\n" 
}
trim ${ALL[@]} | grep -a _cmd | tr -d ",\t\r " > $TMP

[ "x$1" != "x" ] && create $TMP > $1 || create $TMP

exit 0
